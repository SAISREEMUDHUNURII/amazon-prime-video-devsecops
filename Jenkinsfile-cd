pipeline {
  agent any

  environment {
    DOCKER_IMAGE = 'saisreemudhunurii/primevideo-app:latest'
    CONTAINER_NAME = 'primevideo-app'
    HOST_PORT = '3001'
    CONTAINER_PORT = '3000'
  }

  stages {

    stage('üõë Stop & Remove Old Container') {
      steps {
        script {
          echo "Checking for existing container: $CONTAINER_NAME"
          sh """
            if [ \$(docker ps -a -q -f name=^/${CONTAINER_NAME}\$ | wc -l) -gt 0 ]; then
              echo "Stopping and removing existing container: $CONTAINER_NAME"
              docker stop $CONTAINER_NAME || true
              docker rm $CONTAINER_NAME || true
            else
              echo "‚úÖ No container named $CONTAINER_NAME exists."
            fi
          """
        }
      }
    }

    stage('üì• Pull Docker Image from DockerHub') {
      steps {
        echo "Pulling latest image: $DOCKER_IMAGE"
        sh "docker pull $DOCKER_IMAGE"
      }
    }

    stage('üöÄ Run New Docker Container') {
      steps {
        echo "Running container: $CONTAINER_NAME"
        sh "docker run -d --name $CONTAINER_NAME --restart unless-stopped -p $HOST_PORT:$CONTAINER_PORT $DOCKER_IMAGE"
      }
    }
  }

  post {
    success {
      echo '‚úÖ Deployment successful.'
    }
    failure {
      echo '‚ùå Deployment failed.'
    }
  }
}
